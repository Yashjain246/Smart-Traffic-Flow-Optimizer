<script>
  let Module, cars = [];
  let wasmReady = false;

  function log(message) {
    const logDiv = document.getElementById("log");
    const entry = document.createElement("div");
    entry.className = "log-entry";
    entry.textContent = `â†’ ${message}`;
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // âœ… Load and wrap exported C++ functions
  createModule().then(mod => {
    Module = mod;
    log("ðŸš€ WebAssembly module loaded.");

    Module._startSimulation = Module.cwrap('startSimulation', 'void', []);
    Module._stopSimulation = Module.cwrap('stopSimulation', 'void', []);
    Module._emergencyOverride = Module.cwrap('emergencyOverride', 'void', []);

    wasmReady = true;
  });

  function startSimulation() {
    if (wasmReady && Module._startSimulation) {
      Module._startSimulation();
      log("âœ… Simulation started");
      animateTraffic();
      addCar(0, 40, "lime");
      addCar(50, 100, "orange");
    } else log("âš ï¸ startSimulation not found or WebAssembly not ready");
  }

  function stopSimulation() {
    if (wasmReady && Module._stopSimulation) {
      Module._stopSimulation();
      log("ðŸ›‘ Simulation stopped");
    } else log("âš ï¸ stopSimulation not found or WebAssembly not ready");
  }

  function emergencyOverride() {
    if (wasmReady && Module._emergencyOverride) {
      Module._emergencyOverride();
      log("ðŸš¨ Emergency override triggered");
    } else log("âš ï¸ emergencyOverride not found or WebAssembly not ready");
  }

  function addCar(x, y, color) {
    cars.push({ x, y, color });
  }

  function updateCarPositions() {
    for (let car of cars) {
      car.x += 2;
      if (car.x > 800) car.x = -50;
    }
  }

  function drawCars(ctx) {
    ctx.clearRect(0, 0, 800, 300);
    for (let car of cars) {
      ctx.fillStyle = car.color;
      ctx.fillRect(car.x, car.y, 40, 20);
    }
  }

  function animateTraffic() {
    const canvas = document.getElementById("trafficCanvas");
    const ctx = canvas.getContext("2d");
    function loop() {
      updateCarPositions();
      drawCars(ctx);
      requestAnimationFrame(loop);
    }
    loop();
  }

  const waitChart = new Chart(document.getElementById('waitChart'), {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'Wait Time (s)',
        data: [],
        backgroundColor: '#00c6ff'
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } }
    }
  });

  function updateWaitGraph(vehicleId, waitTime) {
    waitChart.data.labels.push(`V${vehicleId}`);
    waitChart.data.datasets[0].data.push(waitTime);
    waitChart.update();
  }

  const map = L.map('map').setView([28.6139, 77.2090], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  function addVehicleMarker(lat, lon, label = "Vehicle") {
    L.marker([lat, lon]).addTo(map).bindPopup(label);
  }
</script>
