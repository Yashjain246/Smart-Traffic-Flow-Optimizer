<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Flow Optimizer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent-primary: #00aaff;
            --accent-hover: #0088cc;
            --border-radius: 16px;
            --panel-bg: rgba(30, 30, 40, 0.6);
            --panel-border: 1px solid rgba(255, 255, 255, 0.15);
        }
        body { font-family:var(--font-family); background:#0f0f1a; color:var(--text-primary); margin:0; padding:2rem; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
        .background-shapes { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; overflow: hidden; }
        .background-shapes::before, .background-shapes::after { content:''; position:absolute; border-radius:50%; filter:blur(100px); opacity:0.5; }
        .background-shapes::before { background:linear-gradient(90deg, #ff00ff, #00ffff); width:400px; height:400px; top:10%; left:15%; animation:move-shape 15s infinite alternate; }
        .background-shapes::after { background:linear-gradient(90deg, #ff9900, #ff00ff); width:300px; height:300px; bottom:10%; right:15%; animation:move-shape 20s infinite alternate-reverse; }
        @keyframes move-shape { from { transform:translate(0, 0) rotate(0deg); } to { transform:translate(100px, 50px) rotate(180deg); } }
        .container { width:100%; max-width:1400px; animation:fade-in 1s ease-out; }
        @keyframes fade-in { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        header { text-align:center; margin-bottom:3rem; }
        header h1 { font-size:2.5rem; font-weight:700; margin:0; }
        header p { color:var(--text-secondary); font-size:1.1rem; margin-top:0.5rem; }
        main { display:grid; grid-template-columns:1fr 2fr; gap:2rem; }
        .panel { background:var(--panel-bg); border:var(--panel-border); border-radius:var(--border-radius); padding:2rem; box-shadow:0 8px 32px 0 rgba(0,0,0,0.37); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); }
        .panel-header { margin-bottom:1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { margin:0; font-size:1.5rem; font-weight:500; }
        .panel-header span { font-size:0.9rem; color:var(--text-secondary); }
        .mode-selector { display:flex; gap:1rem; margin-bottom:1.5rem; background:rgba(0,0,0,0.2); border-radius:8px; padding:0.5rem; }
        .mode-selector label { flex:1; text-align:center; padding:0.5rem; border-radius:6px; cursor:pointer; transition:background-color 0.3s ease; }
        .mode-selector input { display:none; }
        .mode-selector input:checked + label { background-color:var(--accent-primary); color:white; }
        .form-group { margin-bottom:1.25rem; }
        label { display:block; font-weight:500; margin-bottom:0.5rem; font-size:0.9rem; }
        input[type="number"], textarea, select { width:100%; background-color:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:0.75rem 1rem; color:var(--text-primary); font-family:var(--font-family); font-size:1rem; box-sizing:border-box; transition:all 0.2s ease-in-out; }
        input[type="number"]:focus, textarea:focus, select:focus { outline:none; border-color:var(--accent-primary); box-shadow:0 0 0 3px rgba(0,170,255,0.25); }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a0a0a0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 1rem center; background-size: .65em auto; }
        select option { background: #1e1e1e; color: var(--text-primary); }
        textarea { resize:vertical; font-family:'Menlo', 'Monaco', monospace; }
        button { width:100%; padding:0.85rem; font-size:1rem; font-weight:700; color:#fff; background:var(--accent-primary); border:none; border-radius:8px; cursor:pointer; transition:all 0.2s ease-in-out; margin-top:1rem; }
        button:hover { background-color:var(--accent-hover); transform:translateY(-2px); box-shadow:0 4px 15px rgba(0,170,255,0.3); }
        button:disabled { background-color:#555; cursor:not-allowed; transform:none; box-shadow:none; }
        #output-log { background-color:rgba(0,0,0,0.3); border-radius:8px; padding:1.5rem; height:450px; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word; font-family:'Menlo', 'Monaco', monospace; font-size:0.9rem; color:#c0c0c0; border:1px solid rgba(255,255,255,0.1); }
        #manual-mode-inputs { display:none; }
        .gemini-button { background: linear-gradient(45deg, #8a2be2, #4169e1); border: none; font-size: 0.8rem; padding: 0.5rem 1rem; width: auto; margin-top: 0; margin-left: 1rem; }
        .gemini-button:hover { background: linear-gradient(45deg, #9932cc, #5a7edc); }
        .gemini-button:disabled:hover { cursor: not-allowed; background: #555; }
        .gemini-input-group { display:flex; align-items:center; gap:0.5rem; }
        .gemini-input-group select { flex-grow: 1; }
        #analysis-panel { margin-top: 2rem; display: none; }
        #analysis-output { min-height: 100px; background-color: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); white-space: pre-wrap; font-family: var(--font-family); color: var(--text-secondary); }
        .loader { width: 20px; height: 20px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width:900px) { main { grid-template-columns:1fr; } body { padding:1rem; align-items:flex-start; } }
    </style>
</head>
<body>
    <div class="background-shapes"></div>
    <div class="container">
        <header>
            <h1>Smart Traffic Flow Optimizer</h1>
            <p>Dynamic traffic management powered by C++ and WebAssembly</p>
        </header>
        <main>
            <div class="panel" id="input-panel">
                <div class="panel-header">
                    <h2>Configuration</h2>
                    <span>Select input mode and set parameters</span>
                </div>
                <form id="simulation-form">
                    <div class="mode-selector">
                        <input type="radio" id="mode-random" name="sim-mode" value="random" checked>
                        <label for="mode-random">Random</label>
                        <input type="radio" id="mode-manual" name="sim-mode" value="manual">
                        <label for="mode-manual">Manual</label>
                    </div>
                    
                    <div id="random-mode-inputs">
                        <div class="form-group">
                            <label for="numVehicles">Number of Vehicles</label>
                            <input type="number" id="numVehicles" value="15" required>
                        </div>
                        <div class="form-group">
                            <label for="startNode">Emergency Vehicle Start</label>
                            <input type="number" id="startNode" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="endNode">Emergency Vehicle Destination</label>
                            <input type="number" id="endNode" value="5" required>
                        </div>
                    </div>

                    <div id="manual-mode-inputs">
                         <div class="form-group">
                            <label for="scenario-select">Select a Traffic Scenario</label>
                             <div class="gemini-input-group">
                                <select id="scenario-select">
                                    <option value="" disabled selected>Choose a scenario...</option>
                                    <option value="A standard morning rush hour with 15 vehicles and heavy traffic.">Morning Rush Hour</option>
                                    <option value="A quiet night with 5 cars.">Quiet Night</option>
                                    <option value="A major accident at intersection 3, causing a bottleneck, with an ambulance needing to get from 0 to 5.">Accident & Emergency</option>
                                    <option value="A steady flow of 10 vehicles with no major incidents.">Steady Mid-day Traffic</option>
                                </select>
                                <button type="button" id="generate-scenario-btn" class="gemini-button">âœ¨ Generate</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleQueue">Vehicle Queue (start end is_emergency)</label>
                            <textarea id="vehicleQueue" rows="6" placeholder="0 5 1&#10;2 4 0&#10;1 3 0"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="simDuration">Simulation Duration (time steps)</label>
                        <input type="number" id="simDuration" value="200" required>
                    </div>
                    <button type="submit" id="runButton" disabled>Loading WASM...</button>
                </form>
            </div>
            <div class="panel" id="output-panel">
                 <div class="panel-header">
                    <div>
                        <h2>Simulation Log</h2>
                        <span>Real-time output from the C++ core</span>
                    </div>
                    <button id="analyze-btn" class="gemini-button" disabled title="Run a simulation to enable analysis">âœ¨ Analyze Results</button>
                </div>
                <pre id="output-log">Simulation results will appear here...</pre>
                <div id="analysis-panel">
                    <div class="panel-header">
                         <h2>AI Analysis</h2>
                    </div>
                    <div id="analysis-output"></div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="module.js"></script> 
    <script>
        // --- Gemini API Configuration ---
        const API_KEY = ""; // Keep this empty, it will be handled by the environment.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

        // --- WASM Module Setup ---
        var Module = {
            print: (function() { const log = document.getElementById('output-log'); return function(text) { if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' '); if (log) { log.textContent += text + "\n"; log.scrollTop = log.scrollHeight; }}; })(),
            printErr: function(text) { if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' '); const log = document.getElementById('output-log'); if (log) { log.textContent += "[ERROR] " + text + "\n"; log.scrollTop = log.scrollHeight; }},
        };
        
        // --- UI Element References ---
        const form = document.getElementById('simulation-form');
        const runButton = document.getElementById('runButton');
        const randomInputs = document.getElementById('random-mode-inputs');
        const manualInputs = document.getElementById('manual-mode-inputs');
        const generateScenarioBtn = document.getElementById('generate-scenario-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisPanel = document.getElementById('analysis-panel');
        const analysisOutput = document.getElementById('analysis-output');

        // --- Event Listeners and Init ---
        window.addEventListener('load', () => {
            if (typeof SmartTrafficModule === 'function') {
                const wasmLoadTimeout = setTimeout(() => {
                    runButton.textContent = 'WASM Load Failed';
                    Module.printErr("The WebAssembly module failed to load. This might be due to your browser's security settings (like Brave Shields) or if the page is opened as a local file (file://). Please try disabling shields or serving the files from a local web server.");
                }, 5000); // 5 second timeout

                SmartTrafficModule(Module).then(instance => {
                    clearTimeout(wasmLoadTimeout); // Success, cancel the timeout
                    runButton.disabled = false;
                    runButton.textContent = 'Run Simulation';
                    console.log("WASM Module loaded and ready.");
                });
            } else {
                 runButton.textContent = 'Loader Script Error';
                 Module.printErr("SmartTrafficModule function not found. Ensure 'module.js' is in the same directory and loaded correctly.");
            }
        });

        document.querySelectorAll('input[name="sim-mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'random') {
                    randomInputs.style.display = 'block';
                    manualInputs.style.display = 'none';
                } else {
                    randomInputs.style.display = 'none';
                    manualInputs.style.display = 'block';
                }
            });
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            runSimulation();
        });

        generateScenarioBtn.addEventListener('click', generateScenario);
        analyzeBtn.addEventListener('click', analyzeResults);
        
        // --- Gemini API Functions ---
        async function callGemini(systemInstruction, userQuery) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response text found.";
            } catch (error) {
                console.error("Gemini API call error:", error);
                return `Error: ${error.message}`;
            }
        }

        async function generateScenario() {
            const scenarioSelect = document.getElementById('scenario-select');
            const vehicleQueueTextarea = document.getElementById('vehicleQueue');
            const userQuery = scenarioSelect.value;

            if (!userQuery) {
                alert("Please select a scenario from the dropdown.");
                return;
            }

            generateScenarioBtn.disabled = true;
            generateScenarioBtn.innerHTML = '<div class="loader"></div>';
            
            const systemInstruction = "You are a traffic simulation expert. Your task is to generate a vehicle queue based on a user's description. The road network has intersections numbered 0 to 5. A vehicle queue is a list of lines, where each line has three space-separated numbers: `start_node end_node is_emergency`. `is_emergency` is 1 for an emergency vehicle and 0 otherwise. Provide ONLY the list of numbers, with no extra explanation or formatting.";
            
            const generatedText = await callGemini(systemInstruction, userQuery);
            
            vehicleQueueTextarea.value = generatedText.trim();
            generateScenarioBtn.disabled = false;
            generateScenarioBtn.innerHTML = 'âœ¨ Generate';
        }

        async function analyzeResults() {
            const logContent = document.getElementById('output-log').textContent;
            
            analysisPanel.style.display = 'block';
            analysisOutput.innerHTML = '<div class="loader"></div>';
            analyzeBtn.disabled = true;
            analyzeBtn.setAttribute('title', 'Analysis in progress...');

            const systemInstruction = "You are a traffic analysis expert. You will be given a log from a traffic simulation. Your task is to provide a concise, one-paragraph summary of what happened, highlighting key events like emergency vehicle paths, points of congestion (if any), and the overall efficiency of the traffic management. Explain the outcome in simple terms without just repeating the log data.";
            
            const analysisText = await callGemini(systemInstruction, logContent);
            
            analysisOutput.textContent = analysisText;
            analyzeBtn.disabled = false;
            analyzeBtn.setAttribute('title', 'Run a new simulation to re-enable analysis');
        }

        // --- Simulation Control ---
        function runSimulation() {
            const log = document.getElementById('output-log');
            log.textContent = 'Initializing simulation...\n\n';
            runButton.disabled = true;
            analyzeBtn.disabled = true;
            analyzeBtn.setAttribute('title', 'Run a simulation to enable analysis');
            analysisPanel.style.display = 'none';
            runButton.textContent = 'Running...';
            
            const mode = document.querySelector('input[name="sim-mode"]:checked').value;
            const simDuration = document.getElementById('simDuration').value;
            let args = [mode, simDuration];

            if (mode === 'random') {
                args.push(
                    document.getElementById('numVehicles').value,
                    document.getElementById('startNode').value,
                    document.getElementById('endNode').value
                );
            } else {
                const vehicleData = document.getElementById('vehicleQueue').value.trim().split(/\s+/).filter(Boolean);
                if(vehicleData.length === 0 || vehicleData.length % 3 !== 0) {
                    Module.printErr("Manual vehicle queue is empty or has incorrect formatting. Please provide data in 'start end is_emergency' format per line.");
                    runButton.disabled = false;
                    runButton.textContent = 'Run Simulation';
                    return;
                }
                args.push(...vehicleData);
            }
            
            setTimeout(() => {
                try {
                    if (Module.callMain) Module.callMain(args);
                } catch (e) {
                    Module.printErr(e.toString());
                } finally {
                    runButton.disabled = false;
                    runButton.textContent = 'Run Simulation';
                    Module.print("\n...Simulation finished.");
                    analyzeBtn.disabled = false; 
                    analyzeBtn.removeAttribute('title');
                }
            }, 50);
        }
    </script>
</body>
</html>

